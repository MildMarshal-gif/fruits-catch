# 2026-02-12 Execution Group A Plan

## 1. 目的
- 実行グループAの4不具合を、同一ブランチ・同一実装サイクルで安全に直せる作業計画を定義する。
- 変更点の依存関係を整理し、1回の実装処理で手戻りと表示回帰を最小化する。

## 2. スコープ
- 対象:
- Fever Time中の点数表示を修正。
- Fever Time中にゲームオーバーになった時、背景が通常時へ戻る不具合を修正（Fever状態維持）。
- スコアとライフのテキスト座標を統一。
- スイカだけアウトラインが入る不具合を修正。
- 非対象:
- 新機能追加、難易度調整、アセット全面差し替え。
- 既存UI構造の大規模リファクタ。

## 3. 変更タスク一覧（優先順）
1. Fever Time中の点数表示を修正
- 原因仮説:
- 表示の基準が複数化している。`scoreEl.textContent` の実値更新（`scripts/game.js`）と、HUD装飾状態（`scripts/ui.js` の `updateScoreCardState` / `updateScorePulseStyles`）の切替が別タイミングで走り、Fever境界で見え方がズレる。
- 加点テキストは `basePts ×2 = +got` だが、HUD本体は都度素の合計値のみ更新で、Fever演出中の強調色・倍率表示と認知不整合が起きる。
- 影響ファイル候補:
- `scripts/game.js`
- `scripts/ui.js`
- `styles/main.css`

2. Fever中ゲームオーバー時の背景通常化バグ修正（Fever状態維持）
- 原因仮説:
- `endGame()` 内で `fever = false; clearFeverVisualState();` を即時実行しており、ゲームオーバー遷移時にFever背景フェーズが強制終了される。
- その結果、演出上は「Fever中に終了」なのに背景だけ通常状態へ戻る。
- 影響ファイル候補:
- `scripts/game.js`
- `scripts/ui.js`（必要ならオーバーレイ表示時のFeverバッジ制御のみ）

3. スコアとライフのテキスト座標を統一
- 原因仮説:
- `Score` と `Life` で内部要素の整列基準が微妙に異なる（`#score` は個別transform、`hearts` は別レイアウト）。
- レスポンシブ時の `font-size` / `line-height` / `align-items` がカードごとに視覚中心をズラしている。
- 影響ファイル候補:
- `styles/main.css`
- `index.html`（必要最小限のラッパークラス追加が必要な場合のみ）
- `scripts/ui.js`（動的class切替に不足がある場合のみ）

4. スイカだけアウトラインが入る不具合を修正
- 原因仮説:
- スイカ画像アセット自体に白縁が強く含まれており、他果物より輪郭が目立つ。
- さらに、果物POPティントだけ `watermelon => #ff1a1a` の特別分岐があり、ヒット時にスイカだけ輪郭感が強調される。
- フォールバック描画側でも `drawWatermelon` 固有の外周ストロークがあり、画像未使用時との差分が生じる。
- 影響ファイル候補:
- `scripts/game.js`
- `scripts/engine/assets.js`（ティント閾値やティント方式を触る場合）
- `assets/images/game-objects/fruit_watermelon_v2.png`（アセット修正を採る場合）

## 4. 実装順序（1回処理向け）
- おすすめ:
1. 再現条件を固定化する。
- Fever開始直後、Fever終端直前、Fever中ゲームオーバーの3パターンを同一手順で再現し、現状スクショを取得。
2. 状態遷移の中核を先に直す。
- `endGame()` のFever強制解除ロジックを見直し、「Fever中に終了した場合は背景/HUD演出状態を保持」するルールを先に確定する。
3. 点数表示ロジックを統一する。
- HUD実値更新・倍率表示・Fever強調を1系統の更新関数経由へ寄せる。
4. HUD座標の統一を実施する。
- `Score` と `Life` の `stat-value` 内でベースライン/縦中央基準を同じルールに揃える。
5. スイカアウトライン問題を最後に処理する。
- まずコード側（ティント/描画）で揃え、必要時のみアセット補正へ進む。
6. 4項目をまとめて回帰確認する。
- Fever関連、HUD配置、果物見た目を同一テストセッションで通す。
- 代案:
- 先にアセット（`fruit_watermelon_v2.png`）を差し替える運用も可能。ただし差し替えはレビューコストが高く、まずコード側での吸収を優先する。

## 5. テスト計画
- 手動テスト手順:
1. 通常プレイで果物取得し、`Score` の加算値とHUD実値が一致することを確認。
2. 星取得でFever突入し、`×2` 表示、加点表示、合計スコア更新が整合することを確認。
3. Fever中にミスを重ねてゲームオーバーにし、背景が通常へ戻らずFever状態を保持して見えることを確認。
4. リスタート後は通常背景に戻ることを確認（Fever状態が次ゲームへ持ち越されないこと）。
5. PC（16:9）とスマホ幅（<=700px想定）で `Score` と `Life` のラベル/値の位置が同一基準に見えることを確認。
6. 全果物を表示し、スイカだけ不自然な輪郭強調が残らないことを確認。
7. 低品質モード/通常モードの双方で表示崩れがないことを確認。
- 必要なら最小の自動テスト案:
1. DOMスモーク（最小）:
- `scripts/ui.js` の `updateScoreCardState` に対し、`fever=true/false` と `feverPhase` 組み合わせで class 付与が期待通りかを検証。
2. 状態遷移ユニット（最小）:
- `endGame()` 相当のロジックを関数分離し、`fever=true` で終了時に演出フラグ保持、`resetState()` で初期化されることを検証。
3. 画像差分スモーク（任意）:
- スイカ/他果物の描画結果を同条件で比較し、輪郭ピクセル密度の極端差がないことを閾値で確認。

- 完了条件（Definition of Done）:
- Fever中の加点表示、倍率表示、HUD実スコアが矛盾しない。
- Fever中ゲームオーバー時に背景演出が通常へ即戻りしない。
- `Score` と `Life` のテキスト座標がPC/モバイルで統一され、視覚ズレが再現しない。
- スイカのみの不自然なアウトラインが解消される。
- 既存のPause/Resume/Restart/Fever終了時挙動に新規回帰がない。

## 6. リスクと対策
- リスク: Fever状態保持の修正で、次ゲーム開始時までFever演出が残留する。
- 対策: `endGame()` と `resetState()` の責務を分離し、終了時保持・開始時初期化を明確化する。
- リスク: 点数表示の更新経路統一で、通常時のスコア演出が弱くなる。
- 対策: Fever時と通常時の表示差分をテスト観点に含め、数値更新と演出更新を分離設計する。
- リスク: HUD座標調整でモバイル時にボタンやバッジと干渉する。
- 対策: `hud-main` のみ調整し、`hud-side` レイアウトルールは維持して確認する。
- リスク: スイカ輪郭をコードで弱めた結果、他FX（ポップ・ハイライト）の視認性が落ちる。
- 対策: スイカ限定分岐を最小化し、全果物共通ルールに寄せる。

## 7. 要確認事項
- Fever中ゲームオーバー時の「保持対象」は背景だけか、`×2` バッジやFeverバッジ残表示も含むか。
- Fever中の点数表示修正は「表示整合のみ」か、「仕様として表示文言（例: `+10 (x2)`）変更」まで許容か。
- スイカアウトライン修正はコードのみで完結させるか、画像アセット差し替えも許容か。
- HUD座標統一の合格基準は、ピクセル一致か、目視一致（軽微な差は許容）か。

## 実装依頼用プロンプト
```text
あなたはこのリポジトリの実装担当。以下の実行グループAを1回の実装処理でまとめて対応して。

対象:
- Fever Time中の点数表示を修正
- Fever Time中にゲームオーバーになった時、背景が通常時へ戻る不具合を修正（Fever状態維持）
- スコアとライフのテキスト座標を統一
- スイカだけアウトラインが入る不具合を修正

制約:
- 変更は最小差分で実施
- 既存のPause/Resume/Restart/Fever終了挙動を壊さない
- 影響ファイルを明示し、変更理由をコードコメントまたは実装メモで説明

優先実装順:
1) Fever終了/ゲームオーバー時の状態遷移修正
2) Fever中スコア表示ロジックの整合化
3) HUDのScore/Life座標統一
4) スイカアウトライン問題の解消（コード側優先、必要時のみアセット）

想定影響ファイル:
- scripts/game.js
- scripts/ui.js
- styles/main.css
- 必要時: scripts/engine/assets.js, assets/images/game-objects/fruit_watermelon_v2.png

テスト要件:
- 手動:
  - Fever中の加点表示と合計スコア整合
  - Fever中ゲームオーバー時の背景保持
  - リスタート時の正常初期化
  - PC/モバイルでScore/Life位置統一
  - スイカのみ輪郭強調の解消
- 最小自動:
  - updateScoreCardStateの状態組み合わせテスト
  - endGame/resetStateのFever保持と初期化テスト

完了条件:
- 4項目すべて再現しなくなる
- 主要回帰（Pause/Resume/Restart/Fever）なし
- 変更ファイル一覧と検証結果を簡潔に報告
```
