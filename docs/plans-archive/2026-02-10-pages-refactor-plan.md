# GitHub Pages向け分割リファクタ実装プラン（2026-02-10）

## 要点サマリ
- 現状は `index.html` 単一ファイル（`<style>` が 12-809 行、`<script>` が 880-3940 行）で、IIFE内にゲーム全機能が同居している。
- 変更方針は「機能追加なし・数値調整なし・呼び出し順維持」の機械的分割。見た目/挙動/難易度/演出タイミングは固定。
- 分割は `styles/main.css`、`scripts/main.js`、`scripts/ui.js`、`scripts/game.js` の4点を軸に、依存を明示して段階移行する。
- GitHub Pages固有の破損ポイント（`/<repo>/`、相対パス、キャッシュ、404）を事前封じ込めする。
- 同等性検証は手動シナリオ10件 + 自動スモーク（コンソールエラー0件等）で判定し、受け入れ条件を数値化する。

## 前提と仮定
- 前提:
- 公開先は GitHub Pages の Project Pages（URL想定: `https://<user>.github.io/<repo>/`）。
- 既存資産は `assets/images/...` に存在し、現状 `assets/sounds/` は未使用。
- JavaScriptは単一IIFE内で完結し、ES Modules未使用。
- 仮定:
- リポジトリ名は将来変更の可能性があるため、絶対パス（`/assets/...`）は使わない。
- 既存のWebAudio（効果音/BGM生成）はそのまま維持し、音源ファイル化は行わない。
- `assets/sounds/` は将来拡張向けに空ディレクトリ（必要なら `.gitkeep`）として管理する。

## 現状把握の観点（分割前に固定する観測点）
### 1. 分割単位
- HTML: DOM骨格、HUD、オーバーレイ、ボタン、`canvas` のみを残す。
- CSS: `index.html` 内 `<style>` 全量を `styles/main.css` に移す。
- JS: 役割で3分割する。
- `main.js`: 共有コンテキスト生成、定数/状態/DOM参照、起動シーケンス、初期イベント配線のエントリ。
- `ui.js`: HUD更新、オーバーレイ/ポーズUI、ライフ表示、スコア表示、入力UI連携。
- `game.js`: 生成/更新/描画ループ、当たり判定、スコア計算、フィーバー演出、アセットロード、音声処理。

### 2. 依存関係
- `ui.js` と `game.js` は共通状態（スコア、ミス数、配列、設定値、DOM参照）を読む。
- `game.js` は `ui.js` の更新関数（例: ライフ表示/パネル表示）を呼ぶ。
- 音声ON/OFFや開始/再開/リスタートはUIイベントからゲーム制御へ接続される。

### 3. グローバル変数
- 現在はIIFEで隠蔽され、事実上グローバル汚染は少ない。
- 分割後は `window.FC` など単一名前空間へ集約し、公開面を最小化する。
- 共有データは `FC.state` と `FC.refs` に限定し、暗黙参照を禁止する。

### 4. 初期化順序
- 現在の末尾順序（`applyResponsiveProfile` → リスナ登録 → `updateHearts` → `resetOverlayTextToStart` → `loadGameAssets` → `requestAnimationFrame(frame)` → `music.setEnabled(false)`）を保持する。
- 分割後も、実行順が一致するようにスクリプト読込順を固定する。

## 分割方式
### おすすめ
- クラシックスクリプト + 共有名前空間方式。
- `index.html` 末尾で以下順に読み込む:
- `scripts/main.js`
- `scripts/ui.js`
- `scripts/game.js`
- `game.js` の末尾で `FC.bootstrap()` を1回だけ実行する。
- 理由: `type="module"` 化によるスコープ/strict/defer差分を避け、挙動差リスクを最小化できる。

### 代案
- ES Modules化（`type="module"` + `import`）。
- 理由: 長期保守性は高いが、今回の「同等性最優先」では差分要因が増える。

## 段階的移行プラン（完了条件つき）
| フェーズ | 目的 | 主作業 | 完了条件 | 工数感 |
|---|---|---|---|---|
| Phase 0: ベースライン固定 | 比較基準を凍結 | 現行 `index.html` の挙動記録（動画/スクショ/主要値ログ） | ベースライン記録が揃い、比較表に初期値が入る | 小 |
| Phase 1: 依存マップ作成 | 分割境界を確定 | 関数一覧、呼び出し元/先、共有状態一覧、初期化順序を表にする | `main/ui/game` への関数割当表と依存図が完成 | 中 |
| Phase 2: CSS分離 | 見た目を無変更で外出し | `<style>` を `styles/main.css` へ移動、`<link rel=\"stylesheet\">` 追加 | 主要画面で視覚差分なし（比較チェック全件一致） | 小 |
| Phase 3: JS骨格分離 | 実行土台を作る | `main.js` に共有名前空間・状態・定数・bootstrap雛形を移す | ページ起動時エラー0件、初期表示が一致 | 中 |
| Phase 4: UIロジック分離 | UI責務を独立 | UI関数/イベント登録を `ui.js` へ移動、参照は `FC` 経由へ統一 | スタート/一時停止/再開/サウンド切替が全て一致 | 中 |
| Phase 5: ゲームロジック分離 | コア挙動を独立 | 更新/描画/当たり判定/スコア/演出/音声/ロードを `game.js` へ移動 | 10シナリオ一致、コンソールエラー0件 | 大 |
| Phase 6: Pages調整と公開確認 | 本番URLで安定化 | 相対パス検証、キャッシュ確認、404方針反映、Pages上で回帰確認 | Project Pages URLでチェックリスト全件合格 | 中 |

## GitHub Pagesで壊れやすい点（明示）
- 相対パス:
- `assets/...`・`styles/...`・`scripts/...` は先頭 `/` なしで統一する。
- `/<repo>/` 配下:
- Project Pagesではルートが `/<repo>/` になる。絶対パスはリンク切れ要因。
- キャッシュ:
- `main.css`/`main.js`/`game.js`/`ui.js` 更新後に旧版キャッシュが残る。
- 対策: クエリバージョン（例 `main.js?v=<shortSHA>`）か、ファイル名バージョニングを採用。
- 404対策:
- 将来URL直打ちや拡張時の保険として `404.html` を `index.html` 同等内容で置く運用を準備。

## リスクと回避策
| リスク | 影響 | 発生しやすい場面 | 回避策 | 検知方法 |
|---|---|---|---|---|
| リンク切れ | 画像/JS/CSS未読込で表示崩れ・起動失敗 | Project Pages配下で絶対パスを使った時 | すべて相対パス化、デプロイ前にURLベースで総点検 | Networkタブで 404/failed が0件 |
| 読み込み順崩れ | `undefined` 参照、初期化失敗 | `main/ui/game` の順序逆転 | スクリプト順固定、`bootstrap` の呼び出し点を1箇所化 | Consoleエラー0件、起動シーケンスログ一致 |
| イベント未登録 | ボタン/入力が効かない | 関数移動時に `addEventListener` 漏れ | イベント登録一覧を事前作成し照合 | 手動シナリオで全操作成功 |
| CSS優先度崩れ | 見た目差分、アニメ変化 | 分離時に順序やセレクタ重複が変化 | CSS移動は順序完全維持、整形のみで意味変更禁止 | スクショ比較で差分しきい値内 |
| 共有状態参照ミス | スコア/ミス/フィーバー挙動不一致 | 暗黙変数を `FC.state` 化する過程 | 共有状態一覧を定義し、参照元を一括置換 | スモークテスト + 主要シナリオ比較 |
| タイミング差分 | 演出開始/終了の体感が変化 | `requestAnimationFrame` 起動点変更 | 初期化順序と `frame` 開始点を固定、待機処理を追加しない | 動画比較で主要イベント時刻差を計測 |

## 同等性検証計画（必須）
### 比較観点
- 画面表示:
- レイアウト、色、フォント、影/グロー、アニメーション速度、キャンバス描画見え方。
- 操作感:
- キーボード/マウス/タッチの反応、入力遅延体感、一時停止と再開の反応時間。
- ゲーム挙動:
- スコア計算、当たり判定、出現率、落下速度、フィーバー遷移、SE/BGMの切替。
- 初期化とリスタート:
- 初回表示、スタート直後、ゲームオーバー後リスタート、サウンド状態保持。

### 手動テスト手順（シナリオ）
1. 初回表示: ロード直後にオーバーレイ/HUD/ボタン文言が一致する。
2. スタート: `スタート！` 押下でゲーム開始、BGM開始、フレーム更新が一致する。
3. 左右移動: キーボード左右とタッチ移動でカゴ追従が一致する。
4. 通常キャッチ: フルーツ取得時の得点加算、SE、ポップ演出が一致する。
5. ミス: 取り逃し時にライフ減少、被ダメ演出、SEが一致する。
6. フィーバー突入: 星取得後の突入演出、残り時間表示、得点2倍が一致する。
7. フィーバー終了: 終了演出と通常状態復帰タイミングが一致する。
8. ポーズ/再開: 一時停止中にゲーム進行停止、再開で連続性が一致する。
9. リスタート: ポーズ画面のリスタートで初期状態復帰が一致する。
10. ゲームオーバー: 3ミス到達時の終了表示、文言、再スタート導線が一致する。

### 自動チェック（可能な範囲）
- コンソールエラー0件:
- Playwright/Puppeteer等でページ読み込み後 `console.error` を収集し0件を確認。
- 主要関数スモーク:
- `bootstrap` 実行後に `frame` ループ開始、主要配列/状態が初期化済みであることを確認。
- リソースロード:
- 主要画像URLのHTTPステータスが全件200であることを確認。

### 受け入れ基準
- 主要シナリオ10件すべて一致（before/after比較表で全件Pass）。
- 致命的不一致0件（起動不可、入力不可、進行停止、得点計算不正を含む）。
- コンソールエラー0件（ローカル・Pages双方）。
- 主要リソース404件数0件。
- 演出タイミング差は、計測可能な主要イベントで±1フレーム相当以内を目標（60fps前提で約16.7ms）。

## 検証チェックリスト
### ローカル確認
- [ ] `index.html` が分割後構成で起動する。
- [ ] CSS読込失敗がない。
- [ ] JS3ファイルが順序どおり読まれる。
- [ ] コンソールエラー/警告（重大）がない。
- [ ] 手動シナリオ10件が全Pass。

### Pages確認
- [ ] `https://<user>.github.io/<repo>/` で表示できる。
- [ ] 主要アセットが `/<repo>/` 配下で404にならない。
- [ ] ハードリロード後も最新JS/CSSが反映される。
- [ ] モバイル実機で入力操作が成立する。

### 回帰確認
- [ ] 得点推移、ミス判定、フィーバー遷移がベースラインと一致。
- [ ] SE/BGM ON/OFFの状態遷移が一致。
- [ ] リスタート後の初期化漏れがない。

## ロールバック手順
1. 公開ブランチで分割コミットを特定する。
2. 緊急時は該当コミットを `git revert` で打ち消し、単一 `index.html` 版へ戻す。
3. GitHub Pages再デプロイ完了後、公開URLで最小スモーク（起動/入力/得点/終了）を実施する。
4. 失敗原因を記録し、再挑戦は「Phase 1依存マップ」からやり直す。

## 工数感
- 全体: 中（1人で 1.5〜3日想定）。
- 内訳目安:
- 小: Phase 0/2（各0.5日未満）
- 中: Phase 1/3/4/6（各0.5〜1日）
- 大: Phase 5（1〜1.5日）

## 実装依頼用プロンプト
```text
目的:
単一 `index.html`（HTML/CSS/JS同居）を、GitHub Pages（Project Pages）でそのまま公開できる複数ファイル構成へリファクタして。

対象構成:
- index.html
- styles/main.css
- scripts/main.js
- scripts/ui.js
- scripts/game.js
- assets/images/
- assets/sounds/

最重要制約:
- 見た目・挙動・ゲーム内容・難易度・演出タイミングを変えない（機能追加/仕様変更禁止）。
- 初期化順序を維持すること。
- すべて相対パスで構成し、Project Pages（`/<repo>/`）で壊れないようにすること。

実装手順:
1) 現行 `index.html` から `<style>` を `styles/main.css` に移動。
2) JSを責務分割:
   - `main.js`: 共有名前空間（例 `window.FC`）、共通状態、定数、DOM参照、bootstrap。
   - `ui.js`: HUD/overlay/pauseなどUI更新とUIイベント配線。
   - `game.js`: ゲームループ、描画、当たり判定、生成、スコア、フィーバー、音声、アセットロード。
3) `index.html` の末尾で `main.js` → `ui.js` → `game.js` の順に読み込む。
4) `game.js` 側で `FC.bootstrap()` を1回だけ呼ぶ。
5) 既存アセット参照（`assets/images/...`）を維持しつつ相対パスを統一。
6) `assets/sounds/` は空でもよいので管理対象にする（必要なら `.gitkeep`）。

検証要件:
- 手動シナリオ10件（初回表示、スタート、移動、通常キャッチ、ミス、フィーバー突入、フィーバー終了、ポーズ/再開、リスタート、ゲームオーバー）を分割前後で比較。
- 受け入れ基準:
  - 主要シナリオ10件すべて一致
  - 致命的不一致0件
  - コンソールエラー0件（ローカル/Pages）
  - 主要リソース404 0件
- 可能なら自動スモーク:
  - `console.error` 監視で0件
  - 起動後の主要初期化状態を確認

GitHub Pages運用要件:
- Project Pages URL（`https://<user>.github.io/<repo>/`）で最終確認する。
- キャッシュ対策として `?v=<shortSHA>` などのバージョン付与を検討する。
- 404対策は将来拡張用に `404.html` の配置方針を残す。

ロールバック:
- 問題発生時は分割コミットを `git revert` して単一 `index.html` 構成へ戻す。

出力:
- 変更ファイル一覧
- 依存関係の要約（main/ui/game）
- 検証結果（シナリオ別Pass/Fail）
- 残課題（あれば）
```
